{% extends '_base.html' %}
{% load static %}

{% block title %}Playgrounds page{% endblock title %}

{% block content %}
<!-- <div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
  <img src="{% static 'images/lithium.png' %}" class="img-fluid" alt="Lithium logo"/>
  <p class="lead">A Django starter project with batteries.</p>
</div> -->
<div class="mb-3">
    <label for="exampleFormControlTextarea1" class="form-label">Example textarea</label>
    <textarea class="form-control" id="code-input" rows="3"></textarea>
</div>
<button type="button" class="btn btn-success" id="run-button">Run Code</button>

<pre id="output"></pre>

<script>
  document.getElementById("run-button").addEventListener("click", async function () {
    const code = document.getElementById("code-input").value;

    // Step 1: Trigger the task
    const response = await fetch("/playground/run_code/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken(),
      },
      body: JSON.stringify({ code: code })
    });

    const { task_id } = await response.json();
    document.getElementById("output").textContent = "Running...";

    // Step 2: Poll for result every second
    const pollInterval = setInterval(async () => {
      const resultResponse = await fetch("/playground/get_result/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken(),
        },
        body: JSON.stringify({ task_id: task_id })
      });

      const resultData = await resultResponse.json();

      if (resultData.status === "completed") {
        clearInterval(pollInterval);

        const result = resultData.result;
        document.getElementById("output").textContent =
          "Output:\n" + result.stdout +
          "\n\nErrors:\n" + result.stderr +
          "\n\nExit Code: " + result.exit_code;
      }
    }, 1000); // poll every second
  });

  function getCSRFToken() {
    let cookieValue = null;
    let name = 'csrftoken';
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>

  

{% endblock content %}
